from pathlib import Path, PureWindowsPath

from Utility.config_handler import get_nested_config
from models.conditional_cgsvae import ConditionalCGSVAE
from models.cgsvae import CGSVAE
import torch
import os
import numpy as np
class LoadModel:
    def __init__(self, config, check_point: int, device: str = 'cuda', append_path: str = ""):
        self.config = config
        self.model_name = get_nested_config(config=self.config, keys=["model", "name"])
        if self.model_name in ['CGSVAE', 'InCGSVAE']:
            self.model = CGSVAE(self.config, initialize_weights=False)
        elif self.model_name == 'cCGSVAE':
            self.model = ConditionalCGSVAE(self.config, initialize_weights=False)
        else:
            raise ValueError(f"The model specified in the config does not exit: {self.model_name}")
        checkpoint_folder_path = Path(
            PureWindowsPath(get_nested_config(config=config, keys=["run_info", "check_points"])))
        model_run_id = get_nested_config(config=config, keys=["run_info", "run_id"])
        self.checkpoint_path = os.path.join(append_path, checkpoint_folder_path,
                                            f"model_run_id_{model_run_id}_epoch_{check_point}.pth")

        if device != 'cpu':
            self.device = get_nested_config(config=config, keys=["device"])
        else:
            self.device = 'cpu'
        self.model.load_state_dict(torch.load(self.checkpoint_path, map_location=self.device, weights_only=True))
        self.model.to(device)
        self.model.eval()

    def get_model(self):
        if self.model_name == 'cCGSVAE':
            return self.model, self.model.decoder, self.device
        else:
            return self.model, self.device

    def get_spectrum_energy_array(self):
        energy = np.array(
            [0.052881, 0.055762, 0.058643, 0.061523, 0.064404, 0.067285, 0.070166, 0.073047, 0.075928, 0.078809,
             0.081689,
             0.08457, 0.087451, 0.090332, 0.093213, 0.096094, 0.098975, 0.10186, 0.10474, 0.10762, 0.1105, 0.11338,
             0.11626,
             0.11914, 0.12202, 0.1249, 0.12778, 0.13066, 0.13354, 0.13643, 0.13931, 0.14219, 0.14507, 0.14795, 0.15083,
             0.15371, 0.15659, 0.15947, 0.16235, 0.16523, 0.16812, 0.171, 0.17388, 0.17676, 0.17964, 0.18252, 0.1854,
             0.18828, 0.19116, 0.19404, 0.19692, 0.1998, 0.20269, 0.20557, 0.20845, 0.21133, 0.21421, 0.21709, 0.21997,
             0.22285, 0.22573, 0.22861, 0.23149, 0.23437, 0.23726, 0.24014, 0.24302, 0.2459, 0.24878, 0.25166, 0.25454,
             0.25742, 0.2603, 0.26318, 0.26606, 0.26895, 0.27183, 0.27471, 0.27759, 0.28047, 0.28335, 0.28623, 0.28911,
             0.29199, 0.29487, 0.29775, 0.30063, 0.30352, 0.3064, 0.30928, 0.31216, 0.31504, 0.31792, 0.3208, 0.32368,
             0.32656, 0.32944, 0.33232, 0.33521, 0.33809, 0.34097, 0.34385, 0.34673, 0.34961, 0.35249, 0.35537, 0.35825,
             0.36113, 0.36401, 0.36689, 0.36978, 0.37266, 0.37554, 0.37842, 0.3813, 0.38418, 0.38706, 0.38994, 0.39282,
             0.3957, 0.39858, 0.40146, 0.40435, 0.40723, 0.41011, 0.41299, 0.41587, 0.41875, 0.42163, 0.42451, 0.42739,
             0.43027, 0.43315, 0.43604, 0.43892, 0.4418, 0.44468, 0.44756, 0.45044, 0.45332, 0.4562, 0.45908, 0.46196,
             0.46484, 0.46772, 0.47061, 0.47349, 0.47637, 0.47925, 0.48213, 0.48501, 0.48789, 0.49077, 0.49365, 0.49653,
             0.49941, 0.50229, 0.50518, 0.50806, 0.51094, 0.51382, 0.5167, 0.51958, 0.52246, 0.52534, 0.52822, 0.5311,
             0.53398, 0.53687, 0.53975, 0.54263, 0.54551, 0.54839, 0.55127, 0.55415, 0.55703, 0.55991, 0.56279, 0.56567,
             0.56855, 0.57144, 0.57432, 0.5772, 0.58008, 0.58296, 0.58584, 0.58872, 0.5916, 0.59448, 0.59736, 0.60024,
             0.60313, 0.60601, 0.60889, 0.61177, 0.61465, 0.61753, 0.62041, 0.62329, 0.62617, 0.62905, 0.63193, 0.63481,
             0.6377, 0.64058, 0.64346, 0.64634, 0.64922, 0.6521, 0.65498, 0.65786, 0.66074, 0.66362, 0.6665, 0.66938,
             0.67227, 0.67515, 0.67803, 0.68091, 0.68379, 0.68667, 0.68955, 0.69243, 0.69531, 0.69819, 0.70107, 0.70396,
             0.70684, 0.70972, 0.7126, 0.71548, 0.71836, 0.72124, 0.72412, 0.727, 0.72988, 0.73276, 0.73564, 0.73853,
             0.74141, 0.74429, 0.74717, 0.75005, 0.75293, 0.75581, 0.75869, 0.76157, 0.76445, 0.76733, 0.77021, 0.7731,
             0.77598, 0.77886, 0.78174, 0.78462, 0.7875, 0.79038, 0.79326, 0.79614, 0.79902, 0.8019, 0.80479, 0.80767,
             0.81055, 0.81343, 0.81631, 0.81919, 0.82207, 0.82495, 0.82783, 0.83071, 0.83359, 0.83647, 0.83936, 0.84224,
             0.84512, 0.848, 0.85088, 0.85376, 0.85664, 0.85952, 0.8624, 0.86528, 0.86816, 0.87104, 0.87393, 0.87681,
             0.87969, 0.88257, 0.88545, 0.88833, 0.89121, 0.89409, 0.89697, 0.89985, 0.90273, 0.90562, 0.9085, 0.91138,
             0.91426, 0.91714, 0.92002, 0.9229, 0.92578, 0.92866, 0.93154, 0.93442, 0.9373, 0.94019, 0.94307, 0.94595,
             0.94883, 0.95171, 0.95459, 0.95747, 0.96035, 0.96323, 0.96611, 0.96899, 0.97188, 0.97476, 0.97764, 0.98052,
             0.9834, 0.98628, 0.98916, 0.99204, 0.99492, 0.9978, 1.0007, 1.0036, 1.0064, 1.0093, 1.0122, 1.0151, 1.018,
             1.0208, 1.0237, 1.0266, 1.0295, 1.0324, 1.0353, 1.0381, 1.041, 1.0439, 1.0468, 1.0497, 1.0525, 1.0554,
             1.0583,
             1.0612, 1.0641, 1.0669, 1.0698, 1.0727, 1.0756, 1.0785, 1.0813, 1.0842, 1.0871, 1.09, 1.0929, 1.0958,
             1.0986,
             1.1015, 1.1044, 1.1073, 1.1102, 1.113, 1.1159, 1.1188, 1.1217, 1.1246, 1.1274, 1.1303, 1.1332, 1.1361,
             1.139,
             1.1418, 1.1447, 1.1476, 1.1505, 1.1534, 1.1563, 1.1591, 1.162, 1.1649, 1.1678, 1.1707, 1.1735, 1.1764,
             1.1793,
             1.1822, 1.1851, 1.1879, 1.1908, 1.1937, 1.1966, 1.1995, 1.2023, 1.2052, 1.2081, 1.211, 1.2139, 1.2167,
             1.2196,
             1.2225, 1.2254, 1.2283, 1.2312, 1.234, 1.2369, 1.2398, 1.2427, 1.2456, 1.2484, 1.2513, 1.2542, 1.2571,
             1.26,
             1.2628, 1.2657, 1.2686, 1.2715, 1.2744, 1.2772, 1.2801, 1.283, 1.2859, 1.2888, 1.2917, 1.2945, 1.2974,
             1.3003,
             1.3032, 1.3061, 1.3089, 1.3118, 1.3147, 1.3176, 1.3205, 1.3233, 1.3262, 1.3291, 1.332, 1.3349, 1.3377,
             1.3406,
             1.3435, 1.3464, 1.3493, 1.3521, 1.355, 1.3579, 1.3608, 1.3637, 1.3666, 1.3694, 1.3723, 1.3752, 1.3781,
             1.381,
             1.3838, 1.3867, 1.3896, 1.3925, 1.3954, 1.3982, 1.4011, 1.404, 1.4069, 1.4098, 1.4126, 1.4155, 1.4184,
             1.4213,
             1.4242, 1.4271, 1.4299, 1.4328, 1.4357, 1.4386, 1.4415, 1.4443, 1.4472, 1.4501, 1.453, 1.4559, 1.4587,
             1.4616,
             1.4645, 1.4674, 1.4703, 1.4731, 1.476, 1.4789, 1.4818, 1.4847, 1.4875, 1.4904, 1.4933, 1.4962, 1.4991,
             1.502,
             1.5048, 1.5077, 1.5106, 1.5135, 1.5164, 1.5192, 1.5221, 1.525, 1.5279, 1.5308, 1.5336, 1.5365, 1.5394,
             1.5423,
             1.5452, 1.548, 1.5509, 1.5538, 1.5567, 1.5596, 1.5625, 1.5653, 1.5682, 1.5711, 1.574, 1.5769, 1.5797,
             1.5826,
             1.5855, 1.5884, 1.5913, 1.5941, 1.597, 1.5999, 1.6028, 1.6057, 1.6085, 1.6114, 1.6143, 1.6172, 1.6201,
             1.6229,
             1.6258, 1.6287, 1.6316, 1.6345, 1.6374, 1.6402, 1.6431, 1.646, 1.6489, 1.6518, 1.6546, 1.6575, 1.6604,
             1.6633,
             1.6662, 1.669, 1.6719, 1.6748, 1.6777, 1.6806, 1.6834, 1.6863, 1.6892, 1.6921, 1.695, 1.6979, 1.7007,
             1.7036,
             1.7065, 1.7094, 1.7123, 1.7151, 1.718, 1.7209, 1.7238, 1.7267, 1.7295, 1.7324, 1.7353, 1.7382, 1.7411,
             1.7439,
             1.7468, 1.7497, 1.7526, 1.7555, 1.7583, 1.7612, 1.7641, 1.767, 1.7699, 1.7728, 1.7756, 1.7785, 1.7814,
             1.7843,
             1.7872, 1.79, 1.7929, 1.7958, 1.7987, 1.8016, 1.8044, 1.8073, 1.8102, 1.8131, 1.816, 1.8188, 1.8217,
             1.8246,
             1.8275, 1.8304, 1.8333, 1.8361, 1.839, 1.8419, 1.8448, 1.8477, 1.8505, 1.8534, 1.8563, 1.8592, 1.8621,
             1.8649,
             1.8678, 1.8707, 1.8736, 1.8765, 1.8793, 1.8822, 1.8851, 1.888, 1.8909, 1.8938, 1.8966, 1.8995, 1.9024,
             1.9053,
             1.9082, 1.911, 1.9139, 1.9168, 1.9197, 1.9226, 1.9254, 1.9283, 1.9312, 1.9341, 1.937, 1.9398, 1.9427,
             1.9456,
             1.9485, 1.9514, 1.9542, 1.9571, 1.96, 1.9629, 1.9658, 1.9687, 1.9715, 1.9744, 1.9773, 1.9802, 1.9831,
             1.9859,
             1.9888, 1.9917, 1.9946, 1.9975, 2.0003, 2.0032, 2.0061, 2.009, 2.0119, 2.0147, 2.0176, 2.0205, 2.0234,
             2.0263,
             2.0292, 2.032, 2.0349, 2.0378, 2.0407, 2.0436, 2.0464, 2.0493, 2.0522, 2.0551, 2.058, 2.0608, 2.0637,
             2.0666,
             2.0695, 2.0724, 2.0752, 2.0781, 2.081, 2.0839, 2.0868, 2.0896, 2.0925, 2.0954, 2.0983, 2.1012, 2.1041,
             2.1069,
             2.1098, 2.1127, 2.1156, 2.1185, 2.1213, 2.1242, 2.1271, 2.13, 2.1329, 2.1357, 2.1386, 2.1415, 2.1444,
             2.1473,
             2.1501, 2.153, 2.1559, 2.1588, 2.1617, 2.1646, 2.1674, 2.1703, 2.1732, 2.1761, 2.179, 2.1818, 2.1847,
             2.1876,
             2.1905, 2.1934, 2.1962, 2.1991, 2.202, 2.2049, 2.2078, 2.2106, 2.2135, 2.2164, 2.2193, 2.2222, 2.225,
             2.2279,
             2.2308, 2.2337, 2.2366, 2.2395, 2.2423, 2.2452, 2.2481, 2.251, 2.2539, 2.2567, 2.2596, 2.2625, 2.2654,
             2.2683,
             2.2711, 2.274, 2.2769, 2.2798, 2.2827, 2.2855, 2.2884, 2.2913, 2.2942, 2.2971, 2.3, 2.3028, 2.3057, 2.3086,
             2.3115, 2.3144, 2.3172, 2.3201, 2.323, 2.3259, 2.3288, 2.3316, 2.3345, 2.3374, 2.3403, 2.3432, 2.346,
             2.3489,
             2.3518, 2.3547, 2.3576, 2.3604, 2.3633, 2.3662, 2.3691, 2.372, 2.3749, 2.3777, 2.3806, 2.3835, 2.3864,
             2.3893,
             2.3921, 2.395, 2.3979, 2.4008, 2.4037, 2.4065, 2.4094, 2.4123, 2.4152, 2.4181, 2.4209, 2.4238, 2.4267,
             2.4296,
             2.4325, 2.4354, 2.4382, 2.4411, 2.444, 2.4469, 2.4498, 2.4526, 2.4555, 2.4584, 2.4613, 2.4642, 2.467,
             2.4699,
             2.4728, 2.4757, 2.4786, 2.4814, 2.4843, 2.4872, 2.4901, 2.493, 2.4958, 2.4987, 2.5016, 2.5045, 2.5074,
             2.5103,
             2.5131, 2.516, 2.5189, 2.5218, 2.5247, 2.5275, 2.5304, 2.5333, 2.5362, 2.5391, 2.5419, 2.5448, 2.5477,
             2.5506,
             2.5535, 2.5563, 2.5592, 2.5621, 2.565, 2.5679, 2.5708, 2.5736, 2.5765, 2.5794, 2.5823, 2.5852, 2.588,
             2.5909,
             2.5938, 2.5967, 2.5996, 2.6024, 2.6053, 2.6082, 2.6111, 2.614, 2.6168, 2.6197, 2.6226, 2.6255, 2.6284,
             2.6312,
             2.6341, 2.637, 2.6399, 2.6428, 2.6457, 2.6485, 2.6514, 2.6543, 2.6572, 2.6601, 2.6629, 2.6658, 2.6687,
             2.6716,
             2.6745, 2.6773, 2.6802, 2.6831, 2.686, 2.6889, 2.6917, 2.6946, 2.6975, 2.7004, 2.7033, 2.7062, 2.709,
             2.7119,
             2.7148, 2.7177, 2.7206, 2.7234, 2.7263, 2.7292, 2.7321, 2.735, 2.7378, 2.7407, 2.7436, 2.7465, 2.7494,
             2.7522,
             2.7551, 2.758, 2.7609, 2.7638, 2.7667, 2.7695, 2.7724, 2.7753, 2.7782, 2.7811, 2.7839, 2.7868, 2.7897,
             2.7926,
             2.7955, 2.7983, 2.8012, 2.8041, 2.807, 2.8099, 2.8127, 2.8156, 2.8185, 2.8214, 2.8243, 2.8271, 2.83,
             2.8329,
             2.8358, 2.8387, 2.8416, 2.8444, 2.8473, 2.8502, 2.8531, 2.856, 2.8588, 2.8617, 2.8646, 2.8675, 2.8704,
             2.8732,
             2.8761, 2.879, 2.8819, 2.8848, 2.8876, 2.8905, 2.8934, 2.8963, 2.8992, 2.9021, 2.9049, 2.9078, 2.9107,
             2.9136,
             2.9165, 2.9193, 2.9222, 2.9251, 2.928, 2.9309, 2.9337, 2.9366, 2.9395, 2.9424, 2.9453, 2.9481, 2.951,
             2.9539,
             2.9568, 2.9597, 2.9625, 2.9654, 2.9683, 2.9712, 2.9741, 2.977, 2.9798, 2.9827, 2.9856, 2.9885, 2.9914,
             2.9942,
             2.9971, 3.0])
        return energy
